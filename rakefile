require 'rubygems'
require 'bundler/setup'
require 'json'
require 'open-uri'
require 'aws-sdk-core'
require 'set'
require 'autostacker24'

SERVICE       = 'tatsu-hubot'
VERSION       = ENV['CIRCLE_BUILD_NUM'] || ENV['VERSION']
SANDBOX       = ENV['SANDBOX'] || ENV['GO_JOB_NAME'].nil? && `whoami`.strip
STACK         = SANDBOX ? "#{SANDBOX}-#{SERVICE}" : SERVICE
TEMPLATE      = File.read("#{SERVICE}-stack.json")

desc "create or update service #{SERVICE} stack"
task :create_or_update do

  fail('VERSION missing') unless VERSION #TODO: determine latest green version for sandboxed deploy

  parameters = {
    KeyName:                "pgarbe-key-pair-euwest1",
    SubnetID:               "subnet-7f885626",
    DesiredCapacity:        "1",
    MaxSize:                "1",
    InstanceType:           "t2.micro",
    ContainerVersion:       VERSION
  }
  Stacker.create_or_update_stack(STACK, TEMPLATE, parameters)
end

desc 'validate template'
task :validate do
  Stacker.validate_template(TEMPLATE)
end

desc 'dump template'
task :dump do
    puts JSON.pretty_generate(JSON(Stacker.template_body(TEMPLATE)))
end

desc 'delete stack'
task :delete do
  Stacker.delete_stack(STACK)
end

task :default do
  puts
  puts 'Use one of the available tasks:'
  system 'rake -T'
end
